#!/usr/bin/env php
<?php

declare(strict_types=1);

namespace webignition\TcpCliProxyServer\Bin;

use webignition\TcpCliProxyServer\Services\ProcessFactory;
use webignition\TcpCliProxyServer\Services\RequestHandler;

const VERSION = 'dev-master';

$pharPath = \Phar::running(false);

if ('' === $pharPath) {
    require 'vendor/autoload.php';
} else {
    require 'phar://server.phar/vendor/autoload.php';
}

$processFactory = new ProcessFactory();

$socket = stream_socket_server("tcp://0.0.0.0:8000", $errno, $errstr);
if (!$socket) {
    echo "$errstr ($errno)<br />\n";
} else {
    while ($connection = stream_socket_accept($socket, -1)) {
        $requestHandler = new RequestHandler($connection, $processFactory);
        $requestHandler->handle();

        fclose($connection);
    }

    fclose($socket);
}
