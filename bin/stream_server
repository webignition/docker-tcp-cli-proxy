#!/usr/bin/env php
<?php

declare(strict_types=1);

namespace webignition\TcpCliProxyServer\Bin;

use Symfony\Component\Process\Process;

const VERSION = 'dev-master';

$pharPath = \Phar::running(false);

if ('' === $pharPath) {
    require 'vendor/autoload.php';
} else {
    require 'phar://server.phar/vendor/autoload.php';
}

$socket = stream_socket_server("tcp://0.0.0.0:8000", $errno, $errstr);
if (!$socket) {
    echo "$errstr ($errno)<br />\n";
} else {
    while ($connection = stream_socket_accept($socket, -1)) {
        $command = fgets($connection);

        $process = Process::fromShellCommandline($command);

        $exitCode = $process->run(function ($type, $buffer) use ($connection) {
            fwrite($connection, $buffer);
        });

        fwrite($connection, "\n" . (string) $exitCode);
        fclose($connection);
    }

    fclose($socket);
}
